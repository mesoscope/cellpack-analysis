# cellpack-analysis AI Guide

- **Goal**: Analyze cellPACK synthetic data vs experimental data; workflows live under [cellpack_analysis/analysis/workflows](cellpack_analysis/analysis/workflows) and packing utilities under [cellpack_analysis/packing](cellpack_analysis/packing).
- **Environment**: Python 3.11 with `uv`; install via `uv sync` (uses dependency groups in [pyproject.toml](pyproject.toml)). Core dependency `cellpack` is pinned to a specific commit; use the repo-managed venv to match versions.
- **Lint/Test routines**: `make lint` runs black/isort/ruff/mypy with 100-char lines and strict typing; `make build` runs pytest; docs via `make docs`. Mypy ignores missing imports for many scientific libs but enforces `disallow_untyped_defs`.
- **Logging**: Package auto-loads `.env` and configures logging via [logging.conf](logging.conf) when imported; otherwise falls back to basicConfig. CLI tools accept `--log_level` where present.
- **Data layout expectations**: Assumes local `data/` with meshes/grids/templates and writes outputs to `results/` and `data/packing_outputs/`; large data is not versioned. Many scripts create subdirs automatically; avoid committing generated data/results.
- **Analysis runner**: [cellpack_analysis/analysis/workflows/run_analysis_workflow.py](cellpack_analysis/analysis/workflows/run_analysis_workflow.py) orchestrates stepwise analyses driven by JSON configs. Steps include `load_common_data`, `calculate_distances`, plotting, EMD/KS tests, occupancy analyses, and optional interpolation.
- **Analysis configs**: Example configs in [cellpack_analysis/analysis/workflows/configs](cellpack_analysis/analysis/workflows/configs); defaults in [configs/defaults.py](cellpack_analysis/analysis/workflows/configs/defaults.py) define structure IDs, distance measures, occupancy params, recalc flags, worker counts, and output formats. `analysis_steps` order controls execution; `recalculate` can be bool or per-step dict to invalidate caches.
- **Data loading & caching**: `_load_common_data` pulls position data from packed outputs via `get_position_data_from_outputs` and meshes via `get_mesh_information_dict_for_structure`, then caches in `shared_data`. Subsequent steps respect `recalculate` flags to avoid recomputation.
- **Distance pipeline**: `distance.get_distance_dictionary` computes distributions, filters invalids, and `normalize_distances` applies optional normalization. KDE plots and central tendency logs are written under `results/<name>/<packing_id>/figures` and `results` root; filenames carry `suffix` and `save_format`.
- **Statistical analyses**: EMD comparisons/logging occur in `run_emd_analysis`; KS tests plus bootstrap live in `run_ks_analysis`; occupancy KDE/ratios and EMD/interpolation live in the corresponding `_run_occupancy_*` helpers, writing figures into per-measure subfolders.
- **Packing workflow**: [cellpack_analysis/packing/run_packing_workflow.py](cellpack_analysis/packing/run_packing_workflow.py) drives recipe/config generation and packing. Config parsing is handled by [cellpack_analysis/packing/workflow_config.py](cellpack_analysis/packing/workflow_config.py) which resolves paths (templates, grids, meshes, outputs), ensures directories exist, and toggles behavior (generate_recipes/configs, dry_run, skip_completed, mean cell, extra structures, 8d sphere data selection, process counts).
- **Packing templates/outputs**: Defaults in [cellpack_analysis/lib/default_values.py](cellpack_analysis/lib/default_values.py) set structure IDs/names, datadir, workflow config path, process counts, and recipe generation flags. Packing config JSONs live under `cellpack_analysis/packing/configs/` with templates expected in `data/templates/` and results in `data/packing_outputs/`.
- **CLIs**: Examples in [README.md](README.md) and [analysis/workflows/README.md](cellpack_analysis/analysis/workflows/README.md); typical commands: `python cellpack_analysis/analysis/workflows/run_analysis_workflow.py --config_file <json> --log_level INFO` and `python cellpack_analysis/packing/run_packing_workflow.py -c <packing_config.json>`.
- **Testing focus**: Existing tests target recipe generation logic (e.g., `update_and_save_recipe` path/seed/count handling, bounding box computation) in [tests/test_recipe_data.py](tests/test_recipe_data.py); add similar isolated tests for new packing utilities.
- **Conventions**: Prefer `pathlib.Path`, keep figures/results organized by the runner-created directories, and respect 100-char formatting. Avoid hardcoding absolute paths; configs and defaults construct paths relative to project root or `data/`.
- **Common pitfalls**: Missing data files/meshes will fail loads; ensure `data/` mirrors expected structure. Setting `recalculate` improperly may reuse stale caches; set per-step flags when regenerating metrics. `dry_run` in packing skips actual packingâ€”disable when needing outputs.
